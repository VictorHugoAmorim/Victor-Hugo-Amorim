/* REPOSTAS PARA AS QUESTÕES 1 E 2 DO LINK https://olxbr.github.io/cultura/challenges/data-analyst.html
   AUTOR: VICTOR HUGO OLIVEIRA DE AMORIM 
*/   

-- ###### 1º PERGUNTA ######
-- Qual o total de leads que o Viva Real e o ZAP Imóveis trouxeram para essa base? 
-- A query deverá retornar: portal e total de leads para cada portal.
-- 1º POSSÍVEL MODO DE RESPOSTA PARA A PRIMEIRA PERGUNTA
SELECT LI.PORTAL AS PORTAL,
	SUM(LE.LEADS) TOTAL_LEADS
FROM TB_LISTINGS LI
JOIN TB_LEADS LE ON LI.LISTING_ID = LE.LISTING_ID

GROUP BY
1 ;
-- SEGUNDO POSSÍVEL MODO DE RESPOTA PARA A PRIMEIRA PERGUNTA
WITH BASE AS (
SELECT LI.PORTAL AS PORTAL,
	LE.LEADS AS LEADS
FROM TB_LISTINGS LI
JOIN TB_LEADS LE ON LI.LISTING_ID = LE.LISTING_ID)

SELECT PORTAL,
	SUM(LEADS)
FROM BASE
GROUP BY 1 ;

-- ###### 2º PERGUNTA ######
-- Qual a proporção de anúncios que um determinado bairro tem em relação à cidade em que está situado? 
-- A query deverá retornar: a cidade, o bairro, o total de anúncios do bairro, 
-- o total de anúncios da cidade e a proporção em porcentagem.

WITH TOTAL_BAIRRO AS (
SELECT LI.CITY AS CIDADE,
	LI.NEIGHBORHOOD AS BAIRRO,
	COUNT(DISTINCT LI.LISTING_ID) AS TOTAL_LISTINGS
FROM TB_LISTINGS LI
GROUP BY LI.CITY, LI.NEIGHBORHOOD),

TOTAL_CIDADE AS (
SELECT 
	LI.CITY AS CIDADE,
	COUNT(DISTINCT LI.LISTING_ID) AS TOTAL_LISTINGS
FROM TB_LISTINGS LI
GROUP BY LI.CITY)

SELECT B.CIDADE,
	B.BAIRRO,
	B.TOTAL_LISTINGS AS TOTAL_ANUNCIOS_BAIRRO,
	C.TOTAL_LISTINGS AS TOTAL_ANUNCIOS_CIDADE,
	ROUND(TRUNC(B.TOTAL_LISTINGS,2) / TRUNC(C.TOTAL_LISTINGS,2), 2) AS PROPORÇÃO_BAIRRO
	
FROM TOTAL_BAIRRO B
JOIN TOTAL_CIDADE C ON B.CIDADE = C.CIDADE
GROUP BY 1,2,3,4
ORDER BY 1,2;